<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>remedi - Programare Medicamente (Schema completƒÉ)</title>

    <!-- PWA Meta Tags (pƒÉstrate pentru func»õionalitate) -->
    <meta name="theme-color" content="#1a237e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="remedi">

    <!-- Link to Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-192x192.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">

    <style>
        /* STYLE-URI PƒÇSTRATE √éN INTEGRALITATE, DOAR ADAUGƒÇRI MINORE PENTRU NOILE C√ÇMPURI */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: #f0f2f5;
            padding: 12px;
            min-height: 100vh;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Install Prompt */
        .install-prompt {
            background: linear-gradient(135deg, #1a237e, #0d1757);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: none;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(26, 35, 126, 0.3);
            flex-shrink: 0;
        }

        .install-prompt.show {
            display: flex;
        }

        .install-prompt-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .install-prompt-icon {
            font-size: 1.5rem;
        }

        .install-prompt-text {
            font-size: 0.9rem;
        }

        .install-prompt-buttons {
            display: flex;
            gap: 8px;
        }

        .install-btn {
            background: white;
            color: #1a237e;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .dismiss-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* Offline Banner */
        .offline-banner {
            background: #ff9800;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: none;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .offline-banner.show {
            display: flex;
        }

        /* Header */
        .header {
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.8rem;
            color: #1a237e;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header h1 span {
            font-size: 2rem;
        }

        .header p {
            color: #424242;
            font-size: 0.95rem;
            margin-top: 2px;
        }

        /* Tab Navigation */
        .tab-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            height: 100%;
        }

        .tab-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: white;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-btn.active {
            background: #1a237e;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(26, 35, 126, 0.3);
        }

        .tab-content {
            flex: 1;
            min-height: 0;
            height: 100%;
            overflow: hidden;
        }

        .tab-pane {
            display: none;
            height: 100%;
            overflow-y: auto;
            padding-right: 5px;
        }

        .tab-pane.active {
            display: block;
        }

        /* Custom scrollbar */
        .tab-pane::-webkit-scrollbar {
            width: 6px;
        }

        .tab-pane::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .tab-pane::-webkit-scrollbar-thumb {
            background: #1a237e;
            border-radius: 10px;
        }

        /* Tab 1: AdaugƒÉ Medica»õie - MODIFICAT pentru schema completƒÉ */
        .form-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .form-card h2 {
            color: #1a237e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .form-scroll {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            color: #424242;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #1a237e;
        }

        /* Stiluri pentru sec»õiunea de √ÆnregistrƒÉri multiple (medicamente) */
        .med-records-section {
            background: #f8f9fc;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #e0e0e0;
        }

        .med-records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .med-records-header h3 {
            color: #1a237e;
            font-size: 1.1rem;
        }

        .btn-add-record {
            background: #1a237e;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .med-record-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            position: relative;
        }

        .med-record-item:last-child {
            margin-bottom: 0;
        }

        .btn-remove-record {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ff4444;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .row3 {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .col3 {
            flex: 1;
        }

        .col3 label {
            font-size: 0.75rem;
            color: #666;
        }

        .col3 input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 6px;
            text-align: center;
        }

        .btn-primary {
            background: #1a237e;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
            margin-top: 5px;
            flex-shrink: 0;
        }

        .btn-primary:hover {
            background: #0d1757;
        }

        .data-management {
            display: flex;
            gap: 8px;
            margin: 10px 0 5px;
            flex-shrink: 0;
        }

        .btn-warning, .btn-danger {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        /* Tab 2: Programul de Azi (afi»ôare adaptatƒÉ) */
        .schedule-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .schedule-card h2 {
            color: #1a237e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .metric {
            background: #f8f9fa;
            padding: 10px 5px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-label {
            color: #666;
            font-size: 0.75rem;
            margin-bottom: 3px;
        }

        .metric-value {
            color: #1a237e;
            font-size: 1.4rem;
            font-weight: bold;
            line-height: 1.2;
        }

        .medication-list {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .med-item {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .med-item:last-child {
            border-bottom: none;
        }

        .med-item.pending {
            background: #fff3e0;
        }

        .med-item.given {
            background: #e8f5e8;
        }

        .med-item.snoozed {
            background: #ffebee;
        }

        .med-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            flex-wrap: wrap;
            gap: 5px;
        }

        .med-time {
            background: #1a237e;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .med-patient {
            font-weight: 600;
            font-size: 1rem;
            color: #333;
        }

        .med-details {
            margin-bottom: 8px;
            color: #666;
            font-size: 0.85rem;
        }
        .med-details small {
            display: block;
            font-size: 0.75rem;
            color: #888;
        }

        .med-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .btn-give {
            background: #4caf50;
            color: white;
        }

        .btn-snooze {
            background: #ff9800;
            color: white;
        }

        .btn-undo {
            background: #9e9e9e;
            color: white;
        }

        .btn-reset {
            background: #f44336;
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
            border: none;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        /* Tab 3: Program Complet (afi»ôare adaptatƒÉ) */
        .schedule-table {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .schedule-table h3 {
            color: #1a237e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .table-scroll {
            flex: 1;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th {
            background: #1a237e;
            color: white;
            padding: 10px 6px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.8rem;
        }

        td {
            padding: 8px 6px;
            border-bottom: 1px solid #e0e0e0;
        }

        .status-badge {
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }

        .status-pending {
            background: #fff3e0;
            color: #ff9800;
        }

        .status-given {
            background: #e8f5e8;
            color: #4caf50;
        }

        .status-snoozed {
            background: #ffebee;
            color: #f44336;
        }

        /* Alerts Section */
        .alerts {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .alerts h3 {
            color: #1a237e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        .alert-box {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            min-height: 70px;
            border-left: 4px solid #1a237e;
            font-size: 0.9rem;
        }

        .alert-item {
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .alert-item:last-child {
            border-bottom: none;
        }

        .alert-critical {
            color: #d32f2f;
            font-weight: 600;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 12px;
            color: #666;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        /* Utility classes */
        .hidden {
            display: none;
        }

        .success-message, .error-message {
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .success-message {
            background: #4caf50;
            color: white;
        }

        .error-message {
            background: #f44336;
            color: white;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: #666;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 3px;
        }

        .status-online {
            background: #4caf50;
            box-shadow: 0 0 8px #4caf50;
        }

        .status-offline {
            background: #ff9800;
            box-shadow: 0 0 8px #ff9800;
        }

        small {
            font-size: 0.75rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Install Prompt -->
        <div class="install-prompt" id="installPrompt">
            <div class="install-prompt-content">
                <span class="install-prompt-icon">üì±</span>
                <div class="install-prompt-text">
                    <strong>InstaleazƒÉ remedi</strong><br>
                    AcceseazƒÉ rapid programul medicamentos
                </div>
            </div>
            <div class="install-prompt-buttons">
                <button class="install-btn" id="installButton">InstaleazƒÉ</button>
                <button class="dismiss-btn" id="dismissInstall">Acum nu</button>
            </div>
        </div>

        <!-- Offline Banner -->
        <div class="offline-banner" id="offlineBanner">
            <span>üì¥</span>
            <span>E»ôti offline. ModificƒÉrile se salveazƒÉ local.</span>
        </div>

        <!-- Header -->
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <h1>
                    <span>
                            <img src="icons/icon-72x72.png" width="24px" height="24px" alt="icon">
                    </span>
                    remedi
                </h1>
                <div class="connection-status" id="connectionStatus">
                    <span class="status-indicator status-online" id="statusIndicator"></span>
                    <span id="statusText">Online</span>
                </div>
            </div>
            <p>Sistem de administrare a medica»õiei (schema completƒÉ)</p>
        </div>

        <!-- Tab Container -->
        <div class="tab-container">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="1">
                    <span>üìù</span> AdaugƒÉ
                </button>
                <button class="tab-btn" data-tab="2">
                    <span>üìä</span> Azi
                </button>
                <button class="tab-btn" data-tab="3">
                    <span>üìã</span> Program
                </button>
            </div>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Tab 1: Add Medication - MODIFICAT -->
                <div class="tab-pane active" id="tab1">
                    <div class="form-card">
                        <h2>
                            <span>üìã</span>
                            AdaugƒÉ Schema CompletƒÉ
                        </h2>

                        <div class="form-scroll">
                            <div id="formMessage" class="hidden"></div>

                            <!-- NUME PACIENT (obligatoriu, unic pe schemƒÉ) -->
                            <div class="form-group">
                                <label for="patientName">Numele pacientului *</label>
                                <input type="text" id="patientName" placeholder="ex: Ion Popescu">
                            </div>

                            <!-- SEC»öIUNE √éNREGISTRƒÇRI MULTIPLE (MEDICAMENTE) -->
                            <div class="med-records-section">
                                <div class="med-records-header">
                                    <h3>Medicamente & doze (zi)</h3>
                                    <button type="button" class="btn-add-record" id="addRecordBtn">+</button>
                                </div>
                                <div id="medRecordsContainer">
                                    <!-- Dinamically generated records will be inserted here -->
                                </div>
                                <small style="display: block; margin-top: 8px;">* Fiecare linie: nume medicament, unitate, diminea»õa, pr√¢nz, seara (nr. comprimate)</small>
                            </div>
                        </div>

                        <button class="btn-primary" id="saveSchemaBtn">SalveazƒÉ Schema</button>

                        <!-- Data management buttons -->
                        <div class="data-management">
                            <button class="btn-warning" id="loadSampleBtn">üìã √éncarcƒÉ Exemplu</button>
                            <button class="btn-danger" id="clearAllBtn">üóëÔ∏è »òterge Tot</button>
                        </div>
                        <small style="display: block; text-align: center; margin-top: 8px;">
                            üíæ Datele se salveazƒÉ automat (CRUD complet)
                        </small>
                    </div>
                </div>

                <!-- Tab 2: Today's Schedule -->
                <div class="tab-pane" id="tab2">
                    <div class="schedule-card">
                        <h2>
                            <span>üìä</span>
                            Programul de Azi
                        </h2>

                        <!-- Metrics -->
                        <div class="metrics">
                            <div class="metric">
                                <div class="metric-label">Pacien»õi</div>
                                <div class="metric-value" id="totalPatients">0</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Total</div>
                                <div class="metric-value" id="totalMeds">0</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Administrate</div>
                                <div class="metric-value" id="completedCount">0</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">√én A»ôteptare</div>
                                <div class="metric-value" id="pendingCount">0</div>
                            </div>
                        </div>

                        <!-- Medication List -->
                        <div id="medicationList" class="medication-list">
                            <div style="text-align: center; padding: 20px; color: #666;">
                                Nu existƒÉ medica»õii programate.
                            </div>
                        </div>

                        <button class="btn-secondary" id="clearCompletedBtn">üóëÔ∏è »òterge Administrate</button>
                    </div>
                </div>

                <!-- Tab 3: Complete Schedule -->
                <div class="tab-pane" id="tab3">
                    <!-- Alerts Section -->
                    <div class="alerts">
                        <h3>
                            <span>üîî</span>
                            AlertƒÉ
                        </h3>
                        <div class="alert-box" id="alertBox">
                            Nu existƒÉ alerte active
                        </div>
                        <button class="btn-secondary" id="checkAlertsBtn" style="margin-top: 10px; width: 100%;">
                            üîÑ VerificƒÉ Medica»õii Restante
                        </button>
                    </div>

                    <!-- Complete Schedule Table -->
                    <div class="schedule-table">
                        <h3>üìã Program Complet</h3>
                        <div class="table-scroll">
                            <table id="scheduleTable">
                                <thead>
                                    <tr>
                                        <th>Pacient</th>
                                        <th>Medicament</th>
                                        <th>Dim</th>
                                        <th>Pr√¢nz</th>
                                        <th>SearƒÉ</th>
                                        <th>Status</th>
                                        <th>Ac»õiuni</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; color: #666; padding: 20px;">
                                            Nu existƒÉ medica»õii programate
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            remedi v2.0 - Schema completƒÉ (pacient + √ÆnregistrƒÉri multiple)
        </div>
    </div>

    <script>
        (function() {
            // ========== STATE MANAGEMENT ==========
            // StructurƒÉ: array de pacien»õi, fiecare cu nume »ôi un array de medicamente (schema)
            let _patients = [];
            let _nextPatientId = 1000; // ID pentru pacien»õi

            const STORAGE_KEY = 'remedi_schema_completa';
            const ID_KEY = 'remedi_next_patient_id';

            // √éncƒÉrcare ini»õialƒÉ
            function loadFromStorage() {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    const savedId = localStorage.getItem(ID_KEY);
                    if (saved) {
                        _patients = JSON.parse(saved);
                        // AsigurƒÉ existen»õa c√¢mpurilor
                        _patients.forEach(patient => {
                            if (!patient.medications) patient.medications = [];
                            patient.medications.forEach(med => {
                                if (!med.status) med.status = 'Pending';
                                if (med.morning === undefined) med.morning = 0;
                                if (med.noon === undefined) med.noon = 0;
                                if (med.evening === undefined) med.evening = 0;
                                if (!med.unit) med.unit = 'comprimate';
                            });
                        });
                    }
                    if (savedId) _nextPatientId = parseInt(savedId) || 1000;
                } catch (e) {}
            }
            loadFromStorage();

            function saveToStorage() {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(_patients));
                    localStorage.setItem(ID_KEY, _nextPatientId.toString());
                } catch (e) {}
            }

            // ========== TAB SWITCHING FIX ==========
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabPanes = document.querySelectorAll('.tab-pane');

            function switchTab(tabNumber) {
                // Update button states
                tabButtons.forEach(btn => {
                    if (parseInt(btn.dataset.tab) === tabNumber) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });

                // Update pane states
                tabPanes.forEach((pane, index) => {
                    if (index === tabNumber - 1) {
                        pane.classList.add('active');
                    } else {
                        pane.classList.remove('active');
                    }
                });
            }

            // Add click handlers to tab buttons
            tabButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabNumber = parseInt(this.dataset.tab);
                    switchTab(tabNumber);
                });
            });

            // ========== HELPERS ==========
            function generatePatientId() {
                return _nextPatientId++;
            }

            // Ob»õine toate √ÆnregistrƒÉrile (medicamente) plate pentru afi»ôare
            function getAllFlatMeds() {
                const flat = [];
                _patients.forEach(patient => {
                    patient.medications.forEach(med => {
                        flat.push({
                            patientId: patient.id,
                            patientName: patient.patientName,
                            medicationId: med.id,
                            medicationName: med.name,
                            unit: med.unit,
                            morning: med.morning,
                            noon: med.noon,
                            evening: med.evening,
                            status: med.status || 'Pending'
                        });
                    });
                });
                return flat;
            }

            // ActualizeazƒÉ statusul unui medicament (dupƒÉ patientId »ôi medicationId)
            function updateMedStatus(patientId, medicationId, newStatus) {
                const patient = _patients.find(p => p.id === patientId);
                if (!patient) return false;
                const med = patient.medications.find(m => m.id === medicationId);
                if (!med) return false;
                med.status = newStatus;
                saveToStorage();
                return true;
            }

            // »òterge medicamente dupƒÉ filtru (folosit pentru "»ôterge administrate")
            function deleteMedsWhere(filterFn) {
                let deletedCount = 0;
                _patients.forEach(patient => {
                    const initialLength = patient.medications.length;
                    patient.medications = patient.medications.filter(m => !filterFn(m, patient));
                    deletedCount += (initialLength - patient.medications.length);
                });
                // EliminƒÉ pacien»õii fƒÉrƒÉ medicamente? (op»õional, pƒÉstrƒÉm)
                saveToStorage();
                return deletedCount;
            }

            // ========== UI RENDER ==========
            const elements = {
                totalPatients: document.getElementById('totalPatients'),
                totalMeds: document.getElementById('totalMeds'),
                completedCount: document.getElementById('completedCount'),
                pendingCount: document.getElementById('pendingCount'),
                medicationList: document.getElementById('medicationList'),
                tableBody: document.getElementById('tableBody'),
                alertBox: document.getElementById('alertBox'),
                formMessage: document.getElementById('formMessage'),
                patientName: document.getElementById('patientName'),
                medRecordsContainer: document.getElementById('medRecordsContainer'),
                addRecordBtn: document.getElementById('addRecordBtn'),
                saveSchemaBtn: document.getElementById('saveSchemaBtn'),
                loadSampleBtn: document.getElementById('loadSampleBtn'),
                clearAllBtn: document.getElementById('clearAllBtn'),
                clearCompletedBtn: document.getElementById('clearCompletedBtn'),
                checkAlertsBtn: document.getElementById('checkAlertsBtn')
            };

            // Contor √ÆnregistrƒÉri dinamice (doar pentru UI)
            function createMedRecordHtml(recordId = null) {
                const id = recordId || Date.now() + Math.random();
                return `
                    <div class="med-record-item" data-record-id="${id}">
                        <button type="button" class="btn-remove-record" data-remove="${id}">‚úï</button>
                        <div class="form-group">
                            <label>Nume medicament *</label>
                            <input type="text" class="med-name" placeholder="ex: Paracetamol" required>
                        </div>
                        <div class="form-group">
                            <label>Unitate (comprimate, ml, etc.)</label>
                            <input type="text" class="med-unit" value="comprimate" placeholder="ex: comprimate">
                        </div>
                        <div class="row3">
                            <div class="col3">
                                <label>Diminea»õa</label>
                                <input type="number" class="med-morning" value="0" min="0" step="0.5">
                            </div>
                            <div class="col3">
                                <label>Pr√¢nz</label>
                                <input type="number" class="med-noon" value="0" min="0" step="0.5">
                            </div>
                            <div class="col3">
                                <label>Seara</label>
                                <input type="number" class="med-evening" value="0" min="0" step="0.5">
                            </div>
                        </div>
                    </div>
                `;
            }

            function renderMedRecords() {
                if (elements.medRecordsContainer) {
                    elements.medRecordsContainer.innerHTML = createMedRecordHtml('init'); // un record implicit
                }
            }
            renderMedRecords();

            // Evenimente pentru adƒÉugare/»ôtergere √ÆnregistrƒÉri
            if (elements.addRecordBtn) {
                elements.addRecordBtn.addEventListener('click', function() {
                    const container = document.getElementById('medRecordsContainer');
                    if (container) {
                        container.insertAdjacentHTML('beforeend', createMedRecordHtml());
                    }
                });
            }

            // Delegare pentru butoane remove
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('btn-remove-record')) {
                    const recordId = e.target.dataset.remove;
                    const recordDiv = document.querySelector(`.med-record-item[data-record-id="${recordId}"]`);
                    if (recordDiv) {
                        recordDiv.remove();
                    }
                }
            });

            // Func»õie pentru a colecta datele din formular
            function getFormSchema() {
                const patientName = elements.patientName ? elements.patientName.value.trim() : '';
                if (!patientName) return { error: 'Numele pacientului este obligatoriu' };

                const recordItems = document.querySelectorAll('.med-record-item');
                if (recordItems.length === 0) return { error: 'AdƒÉuga»õi cel pu»õin un medicament' };

                const medications = [];
                for (let item of recordItems) {
                    const nameInput = item.querySelector('.med-name');
                    const unitInput = item.querySelector('.med-unit');
                    const morningInput = item.querySelector('.med-morning');
                    const noonInput = item.querySelector('.med-noon');
                    const eveningInput = item.querySelector('.med-evening');

                    const name = nameInput ? nameInput.value.trim() : '';
                    if (!name) {
                        return { error: 'Toate medicamentele trebuie sƒÉ aibƒÉ un nume' };
                    }

                    const unit = unitInput ? unitInput.value.trim() : 'comprimate';
                    const morning = morningInput ? parseFloat(morningInput.value) || 0 : 0;
                    const noon = noonInput ? parseFloat(noonInput.value) || 0 : 0;
                    const evening = eveningInput ? parseFloat(eveningInput.value) || 0 : 0;

                    medications.push({
                        id: Date.now() + Math.random() + medications.length, // ID unic
                        name: name,
                        unit: unit,
                        morning: morning,
                        noon: noon,
                        evening: evening,
                        status: 'Pending'
                    });
                }

                return {
                    patientName,
                    medications
                };
            }

            // Salvare schemƒÉ (CREATE)
            function saveSchema() {
                const result = getFormSchema();
                if (result.error) {
                    showFormMessage(result.error, 'error');
                    return;
                }

                const newPatient = {
                    id: generatePatientId(),
                    patientName: result.patientName,
                    medications: result.medications
                };

                _patients.push(newPatient);
                saveToStorage();
                showFormMessage(`Schema pentru ${result.patientName} salvatƒÉ cu succes (${result.medications.length} medicamente)`, 'success');
                // Reset form
                if (elements.patientName) elements.patientName.value = '';
                renderMedRecords(); // reset la un singur record
                renderAll();
            }

            // »òterge tot (CLEAR ALL)
            function clearAll() {
                if (confirm('Sigur dori»õi sƒÉ »ôterge»õi TOATE datele?')) {
                    _patients = [];
                    _nextPatientId = 1000;
                    saveToStorage();
                    renderAll();
                    showFormMessage('Toate datele au fost »ôterse', 'success');
                }
            }

            // √éncarcƒÉ exemplu
            function loadSample() {
                if (confirm('Se vor √Ænlocui datele existente. Continua»õi?')) {
                    _patients = [
                        {
                            id: generatePatientId(),
                            patientName: 'Ion Popescu',
                            medications: [
                                { id: 'm1', name: 'Metformin', unit: 'comprimate', morning: 1, noon: 1, evening: 1, status: 'Pending' },
                                { id: 'm2', name: 'Vitamina D', unit: 'picƒÉturi', morning: 0, noon: 10, evening: 0, status: 'Pending' }
                            ]
                        },
                        {
                            id: generatePatientId(),
                            patientName: 'Maria Ionescu',
                            medications: [
                                { id: 'm3', name: 'Lisinopril', unit: 'comprimate', morning: 1, noon: 0, evening: 0, status: 'Given' },
                                { id: 'm4', name: 'Atorvastatin', unit: 'comprimate', morning: 0, noon: 0, evening: 1, status: 'Snoozed' }
                            ]
                        }
                    ];
                    saveToStorage();
                    renderAll();
                    showFormMessage('Date exemplu √ÆncƒÉrcate', 'success');
                }
            }

            // »òterge administrate (DELETE where status Given)
            function clearCompleted() {
                const deleted = deleteMedsWhere(m => m.status === 'Given');
                if (deleted > 0) {
                    showFormMessage(`${deleted} √ÆnregistrƒÉri »ôterse`, 'success');
                    renderAll();
                } else {
                    showFormMessage('Nicio √Ænregistrare administratƒÉ', 'success');
                }
            }

            // Render metrici
            function renderMetrics() {
                const flat = getAllFlatMeds();
                const uniquePatients = new Set(flat.map(m => m.patientName)).size;
                const total = flat.length;
                const completed = flat.filter(m => m.status === 'Given').length;
                const pending = flat.filter(m => m.status === 'Pending').length;

                if (elements.totalPatients) elements.totalPatients.textContent = uniquePatients;
                if (elements.totalMeds) elements.totalMeds.textContent = total;
                if (elements.completedCount) elements.completedCount.textContent = completed;
                if (elements.pendingCount) elements.pendingCount.textContent = pending;
            }

            // Render listƒÉ azi (Tab 2) - afi»ôƒÉm fiecare medicament ca intrare separatƒÉ
            function renderMedicationList() {
                if (!elements.medicationList) return;
                const flat = getAllFlatMeds().sort((a,b)=> (a.medicationName || '').localeCompare(b.medicationName || ''));
                if (flat.length === 0) {
                    elements.medicationList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Nu existƒÉ medica»õii programate.</div>';
                    return;
                }

                let html = '';
                flat.forEach(m => {
                    const statusClass = m.status ? m.status.toLowerCase() : 'pending';
                    html += `
                        <div class="med-item ${statusClass}">
                            <div class="med-header">
                                <span class="med-patient">${m.patientName}</span>
                            </div>
                            <div class="med-details">
                                <strong>${m.medicationName}</strong> (${m.unit})<br>
                                <small>Dim:${m.morning} | Pr√¢nz:${m.noon} | SearƒÉ:${m.evening}</small>
                            </div>
                            <div class="med-actions">
                                ${m.status === 'Pending' ? 
                                    `<button class="btn-small btn-give" data-patient="${m.patientId}" data-med="${m.medicationId}" data-action="give">‚úÖ Administrat</button>
                                     <button class="btn-small btn-snooze" data-patient="${m.patientId}" data-med="${m.medicationId}" data-action="snooze">‚è±Ô∏è Am√¢nƒÉ</button>` :
                                m.status === 'Given' ?
                                    `<span class="status-badge status-given">‚úì Administrat</span>
                                     <button class="btn-small btn-undo" data-patient="${m.patientId}" data-med="${m.medicationId}" data-action="undo">‚Ü©Ô∏è AnuleazƒÉ</button>` :
                                    `<span class="status-badge status-snoozed">‚è∞ Am√¢nat</span>
                                     <button class="btn-small btn-reset" data-patient="${m.patientId}" data-med="${m.medicationId}" data-action="reset">‚Ü©Ô∏è ReseteazƒÉ</button>`
                                }
                            </div>
                        </div>
                    `;
                });
                elements.medicationList.innerHTML = html;
            }

            // Render tabel complet (Tab 3)
            function renderTable() {
                if (!elements.tableBody) return;
                const flat = getAllFlatMeds().sort((a,b)=> (a.patientName || '').localeCompare(b.patientName || ''));
                if (flat.length === 0) {
                    elements.tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">Nu existƒÉ medica»õii programate</td></tr>';
                    return;
                }

                let html = '';
                flat.forEach(m => {
                    const statusText = m.status === 'Given' ? 'Administrat' : (m.status === 'Snoozed' ? 'Am√¢nat' : '√én a»ôteptare');
                    const statusClass = `status-badge status-${m.status ? m.status.toLowerCase() : 'pending'}`;
                    html += `
                        <tr>
                            <td>${m.patientName}</td>
                            <td>${m.medicationName} (${m.unit})</td>
                            <td>${m.morning}</td>
                            <td>${m.noon}</td>
                            <td>${m.evening}</td>
                            <td><span class="${statusClass}">${statusText}</span></td>
                            <td>
                                <button class="btn-small btn-give" data-patient="${m.patientId}" data-med="${m.medicationId}" data-action="give">‚úÖ</button>
                                <button class="btn-small btn-snooze" data-patient="${m.patientId}" data-med="${m.medicationId}" data-action="snooze">‚è±Ô∏è</button>
                                <button class="btn-small btn-undo" data-patient="${m.patientId}" data-med="${m.medicationId}" data-action="undo">‚Ü©Ô∏è</button>
                            </td>
                        </tr>
                    `;
                });
                elements.tableBody.innerHTML = html;
            }

            // Render alerte
            function renderAlerts() {
                if (!elements.alertBox) return;
                const flat = getAllFlatMeds().filter(m => m.status === 'Pending');
                if (flat.length > 0) {
                    const top = flat.slice(0, 5);
                    let alertHtml = '<div class="alert-item alert-critical">üî¥ √én a»ôteptare:</div>';
                    top.forEach(m => {
                        alertHtml += `<div class="alert-item"> ‚Ä¢ ${m.patientName} - ${m.medicationName} (D${m.morning} P${m.noon} S${m.evening})</div>`;
                    });
                    elements.alertBox.innerHTML = alertHtml;
                } else {
                    elements.alertBox.innerHTML = '<div class="alert-item">‚úÖ Toate medica»õiile sunt la zi</div>';
                }
            }

            function showFormMessage(msg, type) {
                if (!elements.formMessage) return;
                elements.formMessage.textContent = msg;
                elements.formMessage.className = type === 'success' ? 'success-message' : 'error-message';
                elements.formMessage.classList.remove('hidden');
                setTimeout(() => elements.formMessage.classList.add('hidden'), 3000);
            }

            function renderAll() {
                renderMetrics();
                renderMedicationList();
                renderTable();
                renderAlerts();
            }

            // ========== EVENIMENTE ==========
            if (elements.saveSchemaBtn) {
                elements.saveSchemaBtn.addEventListener('click', saveSchema);
            }

            if (elements.clearAllBtn) {
                elements.clearAllBtn.addEventListener('click', clearAll);
            }

            if (elements.loadSampleBtn) {
                elements.loadSampleBtn.addEventListener('click', loadSample);
            }

            if (elements.clearCompletedBtn) {
                elements.clearCompletedBtn.addEventListener('click', clearCompleted);
            }

            if (elements.checkAlertsBtn) {
                elements.checkAlertsBtn.addEventListener('click', () => {
                    renderAlerts();
                    showFormMessage('Alerte actualizate', 'success');
                });
            }

            // Delegare pentru ac»õiuni pe medicamente (update status)
            document.addEventListener('click', function(e) {
                const btn = e.target.closest('button[data-action]');
                if (!btn) return;
                const patientId = parseFloat(btn.dataset.patient);
                const medId = btn.dataset.med;
                const action = btn.dataset.action;
                let newStatus = null;
                if (action === 'give') newStatus = 'Given';
                else if (action === 'snooze') newStatus = 'Snoozed';
                else if (action === 'undo' || action === 'reset') newStatus = 'Pending';

                if (patientId && medId && newStatus) {
                    const success = updateMedStatus(patientId, medId, newStatus);
                    if (success) {
                        showFormMessage('Status actualizat', 'success');
                        renderAll();
                    } else {
                        showFormMessage('Eroare actualizare', 'error');
                    }
                }
            });

            // Ini»õializare
            renderAll();

            // ===== Online/Offline & Service Worker (pƒÉstrat) =====
            function updateOnlineStatus() {
                const ind = document.getElementById('statusIndicator');
                const txt = document.getElementById('statusText');
                const banner = document.getElementById('offlineBanner');
                if (navigator.onLine) {
                    if (ind) ind.className = 'status-indicator status-online';
                    if (txt) txt.textContent = 'Online';
                    if (banner) banner.classList.remove('show');
                } else {
                    if (ind) ind.className = 'status-indicator status-offline';
                    if (txt) txt.textContent = 'Offline';
                    if (banner) banner.classList.add('show');
                }
            }
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(console.log);
            }
        })();
    </script>
</body>
</html>