<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>remedi - Programare Medicamente</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1a237e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="remedi">
    
    <!-- Link to Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-192x192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: #f0f2f5;
            padding: 12px;
            min-height: 100vh;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Install Prompt */
        .install-prompt {
            background: linear-gradient(135deg, #1a237e, #0d1757);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: none;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(26, 35, 126, 0.3);
            flex-shrink: 0;
        }

        .install-prompt.show {
            display: flex;
        }

        .install-prompt-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .install-prompt-icon {
            font-size: 1.5rem;
        }

        .install-prompt-text {
            font-size: 0.9rem;
        }

        .install-prompt-buttons {
            display: flex;
            gap: 8px;
        }

        .install-btn {
            background: white;
            color: #1a237e;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .dismiss-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* Offline Banner */
        .offline-banner {
            background: #ff9800;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: none;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .offline-banner.show {
            display: flex;
        }

        /* Header */
        .header {
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.8rem;
            color: #1a237e;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header h1 span {
            font-size: 2rem;
        }

        .header p {
            color: #424242;
            font-size: 0.95rem;
            margin-top: 2px;
        }

        /* Tab Navigation */
        .tab-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            height: 100%;
        }

        .tab-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: white;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-btn.active {
            background: #1a237e;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(26, 35, 126, 0.3);
        }

        .tab-content {
            flex: 1;
            min-height: 0;
            height: 100%;
            overflow: hidden;
        }

        .tab-pane {
            display: none;
            height: 100%;
            overflow-y: auto;
            padding-right: 5px;
        }

        .tab-pane.active {
            display: block;
        }

        /* Custom scrollbar */
        .tab-pane::-webkit-scrollbar {
            width: 6px;
        }

        .tab-pane::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .tab-pane::-webkit-scrollbar-thumb {
            background: #1a237e;
            border-radius: 10px;
        }

        /* Tab 1: AdaugƒÉ Medica»õie */
        .form-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .form-card h2 {
            color: #1a237e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .form-scroll {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            color: #424242;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #1a237e;
        }

        .form-group textarea {
            resize: none;
            min-height: 60px;
        }

        .btn-primary {
            background: #1a237e;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
            margin-top: 5px;
            flex-shrink: 0;
        }

        .btn-primary:hover {
            background: #0d1757;
        }

        .data-management {
            display: flex;
            gap: 8px;
            margin: 10px 0 5px;
            flex-shrink: 0;
        }

        .btn-warning, .btn-danger {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        /* Tab 2: Programul de Azi */
        .schedule-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .schedule-card h2 {
            color: #1a237e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .metric {
            background: #f8f9fa;
            padding: 10px 5px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-label {
            color: #666;
            font-size: 0.75rem;
            margin-bottom: 3px;
        }

        .metric-value {
            color: #1a237e;
            font-size: 1.4rem;
            font-weight: bold;
            line-height: 1.2;
        }

        .medication-list {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .med-item {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .med-item:last-child {
            border-bottom: none;
        }

        .med-item.pending {
            background: #fff3e0;
        }

        .med-item.given {
            background: #e8f5e8;
        }

        .med-item.snoozed {
            background: #ffebee;
        }

        .med-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            flex-wrap: wrap;
            gap: 5px;
        }

        .med-time {
            background: #1a237e;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .med-patient {
            font-weight: 600;
            font-size: 1rem;
            color: #333;
        }

        .med-details {
            margin-bottom: 8px;
            color: #666;
            font-size: 0.85rem;
        }

        .med-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .btn-give {
            background: #4caf50;
            color: white;
        }

        .btn-snooze {
            background: #ff9800;
            color: white;
        }

        .btn-undo {
            background: #9e9e9e;
            color: white;
        }

        .btn-reset {
            background: #f44336;
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
            border: none;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        /* Tab 3: Program Complet */
        .schedule-table {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .schedule-table h3 {
            color: #1a237e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .table-scroll {
            flex: 1;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th {
            background: #1a237e;
            color: white;
            padding: 10px 6px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.8rem;
        }

        td {
            padding: 8px 6px;
            border-bottom: 1px solid #e0e0e0;
        }

        .status-badge {
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }

        .status-pending {
            background: #fff3e0;
            color: #ff9800;
        }

        .status-given {
            background: #e8f5e8;
            color: #4caf50;
        }

        .status-snoozed {
            background: #ffebee;
            color: #f44336;
        }

        /* Alerts Section (now in Tab 3) */
        .alerts {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .alerts h3 {
            color: #1a237e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        .alert-box {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            min-height: 70px;
            border-left: 4px solid #1a237e;
            font-size: 0.9rem;
        }

        .alert-item {
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .alert-item:last-child {
            border-bottom: none;
        }

        .alert-critical {
            color: #d32f2f;
            font-weight: 600;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 12px;
            color: #666;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        /* Utility classes */
        .hidden {
            display: none;
        }

        .success-message, .error-message {
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .success-message {
            background: #4caf50;
            color: white;
        }

        .error-message {
            background: #f44336;
            color: white;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: #666;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 3px;
        }

        .status-online {
            background: #4caf50;
            box-shadow: 0 0 8px #4caf50;
        }

        .status-offline {
            background: #ff9800;
            box-shadow: 0 0 8px #ff9800;
        }

        small {
            font-size: 0.75rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Install Prompt -->
        <div class="install-prompt" id="installPrompt">
            <div class="install-prompt-content">
                <span class="install-prompt-icon">üì±</span>
                <div class="install-prompt-text">
                    <strong>InstaleazƒÉ remedi</strong><br>
                    AcceseazƒÉ rapid programul medicamentos
                </div>
            </div>
            <div class="install-prompt-buttons">
                <button class="install-btn" id="installButton">InstaleazƒÉ</button>
                <button class="dismiss-btn" id="dismissInstall">Acum nu</button>
            </div>
        </div>

        <!-- Offline Banner -->
        <div class="offline-banner" id="offlineBanner">
            <span>üì¥</span>
            <span>E»ôti offline. ModificƒÉrile se salveazƒÉ local.</span>
        </div>

        <!-- Header -->
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <h1>
                    <span>üíä</span> 
                    remedi
                </h1>
                <div class="connection-status" id="connectionStatus">
                    <span class="status-indicator status-online" id="statusIndicator"></span>
                    <span id="statusText">Online</span>
                </div>
            </div>
            <p>Sistem de administrare a medica»õiei</p>
        </div>

        <!-- Tab Container -->
        <div class="tab-container">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="1">
                    <span>üìù</span> AdaugƒÉ
                </button>
                <button class="tab-btn" data-tab="2">
                    <span>üìä</span> Azi
                </button>
                <button class="tab-btn" data-tab="3">
                    <span>üìã</span> Program
                </button>
            </div>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Tab 1: Add Medication -->
                <div class="tab-pane active" id="tab1">
                    <div class="form-card">
                        <h2>
                            <span>üìã</span>
                            AdaugƒÉ Medica»õie NouƒÉ
                        </h2>
                        
                        <div class="form-scroll">
                            <div id="formMessage" class="hidden"></div>

                            <div class="form-group">
                                <label for="patientName">Numele pacientului *</label>
                                <input type="text" id="patientName" placeholder="ex: Ion Popescu">
                            </div>

                            <div class="form-group">
                                <label for="roomNumber">NumƒÉr salon/pat</label>
                                <input type="text" id="roomNumber" placeholder="ex: 204B">
                            </div>

                            <div class="form-group">
                                <label for="medicationName">Medica»õie *</label>
                                <input type="text" id="medicationName" placeholder="ex: Metformin">
                            </div>

                            <div class="form-group">
                                <label for="dosage">Dozaj</label>
                                <input type="text" id="dosage" placeholder="ex: 500mg">
                            </div>

                            <div class="form-group">
                                <label for="scheduledTime">OrƒÉ administrare *</label>
                                <input type="time" id="scheduledTime" value="08:00">
                            </div>

                            <div class="form-group">
                                <label for="instructions">Instruc»õiuni speciale</label>
                                <textarea id="instructions" placeholder="ex: Se administreazƒÉ √Æn timpul mesei" rows="2"></textarea>
                            </div>
                        </div>

                        <button class="btn-primary" id="addMedicationBtn">AdaugƒÉ √Æn Program</button>
                        
                        <!-- Data management buttons -->
                        <div class="data-management">
                            <button class="btn-warning" id="loadSampleBtn">üìã √éncarcƒÉ Exemplu</button>
                            <button class="btn-danger" id="clearAllBtn">üóëÔ∏è »òterge Tot</button>
                        </div>
                        <small style="display: block; text-align: center; margin-top: 8px;">
                            üíæ Datele se salveazƒÉ automat
                        </small>
                    </div>
                </div>

                <!-- Tab 2: Today's Schedule -->
                <div class="tab-pane" id="tab2">
                    <div class="schedule-card">
                        <h2>
                            <span>üìä</span>
                            Programul de Azi
                        </h2>

                        <!-- Metrics -->
                        <div class="metrics">
                            <div class="metric">
                                <div class="metric-label">Pacien»õi</div>
                                <div class="metric-value" id="totalPatients">0</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Total</div>
                                <div class="metric-value" id="totalMeds">0</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Administrate</div>
                                <div class="metric-value" id="completedCount">0</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">√én A»ôteptare</div>
                                <div class="metric-value" id="pendingCount">0</div>
                            </div>
                        </div>

                        <!-- Medication List -->
                        <div id="medicationList" class="medication-list">
                            <div style="text-align: center; padding: 20px; color: #666;">
                                Nu existƒÉ medica»õii programate.
                            </div>
                        </div>

                        <button class="btn-secondary" id="clearCompletedBtn">üóëÔ∏è »òterge Administrate</button>
                    </div>
                </div>

                <!-- Tab 3: Complete Schedule -->
                <div class="tab-pane" id="tab3">
                    <!-- Alerts Section (moved to top of tab 3) -->
                    <div class="alerts">
                        <h3>
                            <span>üîî</span>
                            AlertƒÉ
                        </h3>
                        <div class="alert-box" id="alertBox">
                            Nu existƒÉ alerte active
                        </div>
                        <button class="btn-secondary" id="checkAlertsBtn" style="margin-top: 10px; width: 100%;">
                            üîÑ VerificƒÉ Medica»õii Restante
                        </button>
                    </div>

                    <!-- Complete Schedule Table -->
                    <div class="schedule-table">
                        <h3>üìã Program Complet</h3>
                        <div class="table-scroll">
                            <table id="scheduleTable">
                                <thead>
                                    <tr>
                                        <th>Ora</th>
                                        <th>Pacient</th>
                                        <th>Salon</th>
                                        <th>Medica»õie</th>
                                        <th>Dozaj</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; color: #666; padding: 20px;">
                                            Nu existƒÉ medica»õii programate
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            remedi v1.0 - Verifica»õi √Æntotdeauna prescrip»õiile
        </div>
    </div>

    <script>
        // ========== STATE MANAGEMENT REFACTORING ==========
        // Create a centralized state object with getters/setters
        // Implement observer pattern for automatic UI updates
        // Add data validation layer before state mutations
        
        // App State Module - Encapsulated and protected
        const AppState = (function() {
            // Private variables (truly private in closure)
            let _medications = [];
            let _nextId = 1;
            
            // Storage keys
            const STORAGE_KEY = 'mediremind_medications';
            const ID_KEY = 'mediremind_nextId';
            
            // Observers list for UI updates
            const observers = [];
            
            // Validation rules
            const validators = {
                medication: function(med) {
                    const errors = [];
                    if (!med.patientName || med.patientName.trim() === '') {
                        errors.push('Numele pacientului este obligatoriu');
                    }
                    if (!med.medicationName || med.medicationName.trim() === '') {
                        errors.push('Denumirea medica»õiei este obligatorie');
                    }
                    if (!med.scheduledTime || med.scheduledTime.trim() === '') {
                        errors.push('Ora de administrare este obligatorie');
                    }
                    // Validate time format (HH:MM)
                    if (med.scheduledTime && !/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(med.scheduledTime)) {
                        errors.push('Formatul orei este invalid (HH:MM)');
                    }
                    return {
                        isValid: errors.length === 0,
                        errors: errors
                    };
                }
            };
            
            // Load from storage on initialization
            (function loadFromStorage() {
                try {
                    const savedMeds = localStorage.getItem(STORAGE_KEY);
                    const savedId = localStorage.getItem(ID_KEY);
                    
                    if (savedMeds) {
                        const parsed = JSON.parse(savedMeds);
                        // Ensure all medications have required fields
                        _medications = parsed.map(med => ({
                            ...med,
                            status: med.status || 'Pending'
                        }));
                    }
                    
                    if (savedId) {
                        _nextId = parseInt(savedId) || 1;
                    }
                } catch (e) {
                    console.error('Failed to load from localStorage:', e);
                    _medications = [];
                    _nextId = 1;
                }
            })();
            
            // Private save function
            function _saveToStorage() {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(_medications));
                    localStorage.setItem(ID_KEY, _nextId.toString());
                    
                    // Trigger background sync if online
                    if (navigator.onLine && 'serviceWorker' in navigator && 'SyncManager' in window) {
                        navigator.serviceWorker.ready.then(registration => {
                            registration.sync.register('sync-medications');
                        });
                    }
                    return true;
                } catch (e) {
                    console.error('Failed to save to localStorage:', e);
                    return false;
                }
            }
            
            // Notify all observers of state change
            function _notifyObservers(action, data) {
                observers.forEach(observer => {
                    try {
                        observer(action, data);
                    } catch (e) {
                        console.error('Observer notification failed:', e);
                    }
                });
            }
            
            // Public API
            return {
                // Subscribe to state changes
                subscribe: function(observer) {
                    if (typeof observer === 'function') {
                        observers.push(observer);
                    }
                    return function unsubscribe() {
                        const index = observers.indexOf(observer);
                        if (index > -1) observers.splice(index, 1);
                    };
                },
                
                // Get all medications (returns a copy to prevent direct mutation)
                getAll: function() {
                    return _medications.map(med => ({ ...med })); // Return shallow copy
                },
                
                // Get medication by id
                getById: function(id) {
                    const med = _medications.find(m => m.id === id);
                    return med ? { ...med } : null;
                },
                
                // Get metrics
                getMetrics: function() {
                    const totalPatients = new Set(_medications.map(m => m.patientName)).size;
                    const totalMeds = _medications.length;
                    const completed = _medications.filter(m => m.status === 'Given').length;
                    const pending = _medications.filter(m => m.status === 'Pending').length;
                    const snoozed = _medications.filter(m => m.status === 'Snoozed').length;
                    
                    return {
                        totalPatients,
                        totalMeds,
                        completed,
                        pending,
                        snoozed
                    };
                },
                
                // Get sorted medications
                getSorted: function(compareFn) {
                    const copy = [..._medications];
                    if (compareFn) {
                        return copy.sort(compareFn);
                    }
                    // Default sort by time
                    return copy.sort((a, b) => a.scheduledTime.localeCompare(b.scheduledTime));
                },
                
                // Get medications by status
                getByStatus: function(status) {
                    return _medications.filter(m => m.status === status).map(m => ({ ...m }));
                },
                
                // Add new medication with validation
                add: function(medicationData) {
                    // Create medication object with id
                    const newMed = {
                        id: _nextId++,
                        patientName: (medicationData.patientName || '').trim(),
                        roomNumber: (medicationData.roomNumber || '‚Äî').trim() || '‚Äî',
                        medicationName: (medicationData.medicationName || '').trim(),
                        dosage: (medicationData.dosage || '‚Äî').trim() || '‚Äî',
                        scheduledTime: medicationData.scheduledTime,
                        instructions: (medicationData.instructions || '‚Äî').trim() || '‚Äî',
                        status: 'Pending'
                    };
                    
                    // Validate
                    const validation = validators.medication(newMed);
                    if (!validation.isValid) {
                        return {
                            success: false,
                            errors: validation.errors,
                            medication: null
                        };
                    }
                    
                    // Add to state
                    _medications.push(newMed);
                    
                    // Save to storage
                    const saved = _saveToStorage();
                    
                    // Notify observers
                    _notifyObservers('ADD', { medication: newMed });
                    
                    return {
                        success: true,
                        errors: [],
                        medication: { ...newMed },
                        saved: saved
                    };
                },
                
                // Update medication status with validation
                updateStatus: function(id, newStatus) {
                    // Validate status
                    const validStatuses = ['Pending', 'Given', 'Snoozed'];
                    if (!validStatuses.includes(newStatus)) {
                        return {
                            success: false,
                            error: 'Status invalid',
                            medication: null
                        };
                    }
                    
                    const index = _medications.findIndex(m => m.id === id);
                    if (index === -1) {
                        return {
                            success: false,
                            error: 'Medica»õia nu a fost gƒÉsitƒÉ',
                            medication: null
                        };
                    }
                    
                    // Store old value for rollback if needed
                    const oldStatus = _medications[index].status;
                    _medications[index].status = newStatus;
                    
                    // Save to storage
                    const saved = _saveToStorage();
                    
                    if (!saved) {
                        // Rollback on save failure
                        _medications[index].status = oldStatus;
                        return {
                            success: false,
                            error: 'Salvarea √Æn stocare a e»ôuat',
                            medication: null
                        };
                    }
                    
                    // Notify observers
                    _notifyObservers('UPDATE_STATUS', { 
                        id, 
                        oldStatus, 
                        newStatus,
                        medication: { ..._medications[index] }
                    });
                    
                    return {
                        success: true,
                        error: null,
                        medication: { ..._medications[index] }
                    };
                },
                
                // Delete medications by filter
                deleteWhere: function(filterFn) {
                    const beforeCount = _medications.length;
                    const deleted = _medications.filter(filterFn);
                    
                    if (deleted.length === 0) {
                        return {
                            success: true,
                            count: 0,
                            deleted: []
                        };
                    }
                    
                    _medications = _medications.filter(m => !filterFn(m));
                    
                    // Save to storage
                    const saved = _saveToStorage();
                    
                    // Notify observers
                    _notifyObservers('DELETE', { 
                        count: beforeCount - _medications.length,
                        deleted: deleted.map(m => ({ ...m }))
                    });
                    
                    return {
                        success: true,
                        count: beforeCount - _medications.length,
                        deleted: deleted.map(m => ({ ...m }))
                    };
                },
                
                // Clear all medications
                clearAll: function() {
                    const deleted = [..._medications];
                    _medications = [];
                    _nextId = 1;
                    
                    // Save to storage
                    const saved = _saveToStorage();
                    
                    // Notify observers
                    _notifyObservers('CLEAR_ALL', { 
                        count: deleted.length,
                        deleted: deleted.map(m => ({ ...m }))
                    });
                    
                    return {
                        success: true,
                        count: deleted.length
                    };
                },
                
                // Load sample data
                loadSample: function() {
                    const sampleMeds = [
                        {
                            patientName: 'Ion Popescu',
                            roomNumber: '204B',
                            medicationName: 'Metformin',
                            dosage: '500mg',
                            scheduledTime: '08:00',
                            instructions: 'Se administreazƒÉ √Æn timpul mesei'
                        },
                        {
                            patientName: 'Maria Ionescu',
                            roomNumber: '105A',
                            medicationName: 'Lisinopril',
                            dosage: '10mg',
                            scheduledTime: '12:30',
                            instructions: 'O datƒÉ pe zi'
                        },
                        {
                            patientName: 'George Dumitrescu',
                            roomNumber: '312',
                            medicationName: 'Atorvastatin',
                            dosage: '20mg',
                            scheduledTime: '20:00',
                            instructions: 'Se administreazƒÉ seara'
                        },
                        {
                            patientName: 'Elena Popa',
                            roomNumber: '407',
                            medicationName: 'LevothyroxinƒÉ',
                            dosage: '75mcg',
                            scheduledTime: '07:00',
                            instructions: '√énainte de micul dejun'
                        },
                        {
                            patientName: 'Vasile Stan',
                            roomNumber: '218',
                            medicationName: 'AmlodipinƒÉ',
                            dosage: '5mg',
                            scheduledTime: '09:00',
                            instructions: 'O datƒÉ pe zi'
                        }
                    ];
                    
                    // Clear existing first
                    _medications = [];
                    _nextId = 1;
                    
                    // Add samples
                    const added = [];
                    sampleMeds.forEach(data => {
                        const newMed = {
                            id: _nextId++,
                            ...data,
                            status: data.patientName === 'Vasile Stan' ? 'Given' : 'Pending'
                        };
                        _medications.push(newMed);
                        added.push(newMed);
                    });
                    
                    // Save to storage
                    const saved = _saveToStorage();
                    
                    // Notify observers
                    _notifyObservers('LOAD_SAMPLE', { 
                        count: added.length,
                        medications: added.map(m => ({ ...m }))
                    });
                    
                    return {
                        success: true,
                        count: added.length
                    };
                },
                
                // Force refresh from storage (in case of external changes)
                refresh: function() {
                    try {
                        const savedMeds = localStorage.getItem(STORAGE_KEY);
                        const savedId = localStorage.getItem(ID_KEY);
                        
                        if (savedMeds) {
                            _medications = JSON.parse(savedMeds);
                        }
                        
                        if (savedId) {
                            _nextId = parseInt(savedId) || 1;
                        }
                        
                        _notifyObservers('REFRESH', {});
                        return true;
                    } catch (e) {
                        console.error('Refresh failed:', e);
                        return false;
                    }
                },
                
                // Get next available ID (for preview purposes)
                getNextId: function() {
                    return _nextId;
                }
            };
        })();

        // ========== UI RENDERING MODULE ==========
        // This module handles all UI updates and depends on AppState
        const UIRenderer = (function() {
            // DOM element references (cached for performance)
            const elements = {
                // Metrics
                totalPatients: document.getElementById('totalPatients'),
                totalMeds: document.getElementById('totalMeds'),
                completedCount: document.getElementById('completedCount'),
                pendingCount: document.getElementById('pendingCount'),
                
                // Lists and tables
                medicationList: document.getElementById('medicationList'),
                tableBody: document.getElementById('tableBody'),
                alertBox: document.getElementById('alertBox'),
                formMessage: document.getElementById('formMessage'),
                
                // Form inputs
                patientName: document.getElementById('patientName'),
                roomNumber: document.getElementById('roomNumber'),
                medicationName: document.getElementById('medicationName'),
                dosage: document.getElementById('dosage'),
                scheduledTime: document.getElementById('scheduledTime'),
                instructions: document.getElementById('instructions')
            };
            
            // Helper: Show message in form
            function showFormMessage(message, type) {
                if (!elements.formMessage) return;
                
                elements.formMessage.textContent = message;
                elements.formMessage.className = type === 'success' ? 'success-message' : 'error-message';
                elements.formMessage.classList.remove('hidden');
                
                setTimeout(() => {
                    elements.formMessage.classList.add('hidden');
                }, 3000);
            }
            
            // Helper: Get current time formatted
            function getCurrentTimeFormatted() {
                const now = new Date();
                return `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            }
            
            // Render metrics
            function renderMetrics() {
                const metrics = AppState.getMetrics();
                
                if (elements.totalPatients) {
                    elements.totalPatients.textContent = metrics.totalPatients;
                }
                if (elements.totalMeds) {
                    elements.totalMeds.textContent = metrics.totalMeds;
                }
                if (elements.completedCount) {
                    elements.completedCount.textContent = metrics.completed;
                }
                if (elements.pendingCount) {
                    elements.pendingCount.textContent = metrics.pending;
                }
            }
            
            // Render actions for a medication (helper)
            function renderActions(med) {
                if (med.status === 'Pending') {
                    return `
                        <button class="btn-small btn-give" data-action="update-status" data-id="${med.id}" data-status="Given">‚úÖ Administrat</button>
                        <button class="btn-small btn-snooze" data-action="update-status" data-id="${med.id}" data-status="Snoozed">‚è±Ô∏è Am√¢nƒÉ</button>
                    `;
                } else if (med.status === 'Given') {
                    return `
                        <span class="status-badge status-given">‚úì Administrat</span>
                        <button class="btn-small btn-undo" data-action="update-status" data-id="${med.id}" data-status="Pending">‚Ü©Ô∏è AnuleazƒÉ</button>
                    `;
                } else { // Snoozed
                    return `
                        <span class="status-badge status-snoozed">‚è∞ Am√¢nat</span>
                        <button class="btn-small btn-reset" data-action="update-status" data-id="${med.id}" data-status="Pending">‚Ü©Ô∏è ReseteazƒÉ</button>
                    `;
                }
            }
            
            // Render medication list (Tab 2)
            function renderMedicationList() {
                if (!elements.medicationList) return;
                
                const medications = AppState.getAll();
                
                if (medications.length === 0) {
                    elements.medicationList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Nu existƒÉ medica»õii programate.</div>';
                    return;
                }
                
                // Sort by time
                const sorted = medications.sort((a, b) => a.scheduledTime.localeCompare(b.scheduledTime));
                
                let html = '';
                sorted.forEach(med => {
                    html += `
                        <div class="med-item ${med.status.toLowerCase()}">
                            <div class="med-header">
                                <span class="med-time">${med.scheduledTime}</span>
                                <span class="med-patient">${med.patientName}</span>
                            </div>
                            <div class="med-details">
                                <strong>${med.medicationName} ${med.dosage}</strong><br>
                                ${med.roomNumber}
                            </div>
                            <div class="med-actions">
                                ${renderActions(med)}
                            </div>
                        </div>
                    `;
                });
                
                elements.medicationList.innerHTML = html;
            }
            
            // Render table (Tab 3)
            function renderTable() {
                if (!elements.tableBody) return;
                
                const medications = AppState.getAll();
                
                if (medications.length === 0) {
                    elements.tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: #666; padding: 20px;">
                                Nu existƒÉ medica»õii programate
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Sort by time
                const sorted = medications.sort((a, b) => a.scheduledTime.localeCompare(b.scheduledTime));
                
                let html = '';
                sorted.forEach(med => {
                    let statusText = '√én a»ôteptare';
                    if (med.status === 'Given') statusText = 'Administrat';
                    if (med.status === 'Snoozed') statusText = 'Am√¢nat';
                    
                    const statusClass = `status-badge status-${med.status.toLowerCase()}`;
                    html += `
                        <tr>
                            <td>${med.scheduledTime}</td>
                            <td>${med.patientName}</td>
                            <td>${med.roomNumber}</td>
                            <td>${med.medicationName}</td>
                            <td>${med.dosage}</td>
                            <td><span class="${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                });
                
                elements.tableBody.innerHTML = html;
            }
            
            // Render alerts (Tab 3)
            function renderAlerts() {
                if (!elements.alertBox) return;
                
                const currentTime = getCurrentTimeFormatted();
                const medications = AppState.getAll();
                
                const dueMeds = medications.filter(m => 
                    m.scheduledTime === currentTime && m.status === 'Pending'
                );
                
                if (dueMeds.length > 0) {
                    let alertHtml = '';
                    dueMeds.forEach(med => {
                        alertHtml += `<div class="alert-item alert-critical">üî¥ <strong>ACUM:</strong> ${med.medicationName} - ${med.patientName}</div>`;
                    });
                    elements.alertBox.innerHTML = alertHtml;
                    
                    // Trigger notification
                    triggerNotification();
                } else {
                    const upcoming = medications
                        .filter(m => m.status === 'Pending')
                        .sort((a, b) => a.scheduledTime.localeCompare(b.scheduledTime))
                        .slice(0, 3);
                    
                    if (upcoming.length > 0) {
                        let upcomingHtml = '<div class="alert-item">üìå <strong>UrmƒÉtoarele:</strong></div>';
                        upcoming.forEach(med => {
                            upcomingHtml += `<div class="alert-item">  ‚Ä¢ ${med.scheduledTime} - ${med.patientName}: ${med.medicationName}</div>`;
                        });
                        elements.alertBox.innerHTML = upcomingHtml;
                    } else {
                        elements.alertBox.innerHTML = '<div class="alert-item">‚úÖ Toate medica»õiile sunt la zi</div>';
                    }
                }
            }
            
            // Trigger browser notification
            function triggerNotification() {
                // Visual feedback
                if (elements.alertBox) {
                    elements.alertBox.style.transition = 'background-color 0.5s';
                    elements.alertBox.style.backgroundColor = '#ffebee';
                    setTimeout(() => {
                        if (elements.alertBox) {
                            elements.alertBox.style.backgroundColor = '#f8f9fa';
                        }
                    }, 500);
                }
                
                // Browser notification
                if (Notification.permission === 'granted') {
                    new Notification('üîî Aten»õie! Medica»õii de administrat!', {
                        body: 'Verifica»õi sec»õiunea de alerte',
                        icon: 'icons/icon-192x192.png'
                    });
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission();
                }
            }
            
            // Clear form inputs
            function clearForm() {
                if (elements.patientName) elements.patientName.value = '';
                if (elements.roomNumber) elements.roomNumber.value = '';
                if (elements.medicationName) elements.medicationName.value = '';
                if (elements.dosage) elements.dosage.value = '';
                if (elements.instructions) elements.instructions.value = '';
                // Keep time field as is
            }
            
            // Public API
            return {
                renderAll: function() {
                    renderMetrics();
                    renderMedicationList();
                    renderTable();
                    renderAlerts();
                },
                
                renderMetrics: renderMetrics,
                renderMedicationList: renderMedicationList,
                renderTable: renderTable,
                renderAlerts: renderAlerts,
                showFormMessage: showFormMessage,
                clearForm: clearForm,
                getCurrentTimeFormatted: getCurrentTimeFormatted,
                
                // Get form data for adding medication
                getFormData: function() {
                    return {
                        patientName: elements.patientName ? elements.patientName.value : '',
                        roomNumber: elements.roomNumber ? elements.roomNumber.value : '',
                        medicationName: elements.medicationName ? elements.medicationName.value : '',
                        dosage: elements.dosage ? elements.dosage.value : '',
                        scheduledTime: elements.scheduledTime ? elements.scheduledTime.value : '',
                        instructions: elements.instructions ? elements.instructions.value : ''
                    };
                }
            };
        })();

        // ========== EVENT HANDLERS MODULE ==========
        // This module sets up all event listeners and handles user interactions
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize UI
            UIRenderer.renderAll();
            
            // Subscribe to state changes for automatic UI updates
            AppState.subscribe(function(action, data) {
                console.log(`State changed: ${action}`, data);
                UIRenderer.renderAll();
                
                // Show feedback for certain actions
                if (action === 'ADD' && data.medication) {
                    UIRenderer.showFormMessage(`‚úÖ ${data.medication.medicationName} adƒÉugat pentru ${data.medication.patientName}`, 'success');
                } else if (action === 'CLEAR_ALL') {
                    UIRenderer.showFormMessage('Toate datele au fost »ôterse', 'success');
                } else if (action === 'LOAD_SAMPLE') {
                    UIRenderer.showFormMessage('Date exemplu √ÆncƒÉrcate', 'success');
                } else if (action === 'DELETE' && data.count > 0) {
                    UIRenderer.showFormMessage(`${data.count} element(e) »ôterse`, 'success');
                }
            });
            
            // ========== TAB SWITCHING ==========
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabPanes = document.querySelectorAll('.tab-pane');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabNumber = parseInt(this.dataset.tab);
                    
                    // Update button states
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update pane states
                    tabPanes.forEach((pane, index) => {
                        if (index === tabNumber - 1) {
                            pane.classList.add('active');
                        } else {
                            pane.classList.remove('active');
                        }
                    });
                });
            });
            
            // ========== ADD MEDICATION ==========
            const addButton = document.getElementById('addMedicationBtn');
            if (addButton) {
                addButton.addEventListener('click', function() {
                    const formData = UIRenderer.getFormData();
                    
                    // Basic validation (additional validation in state)
                    if (!formData.patientName || !formData.medicationName || !formData.scheduledTime) {
                        UIRenderer.showFormMessage('Nume pacient, medica»õie »ôi ora sunt obligatorii', 'error');
                        return;
                    }
                    
                    const result = AppState.add(formData);
                    
                    if (result.success) {
                        UIRenderer.clearForm();
                        // UI is updated automatically via observer
                    } else {
                        UIRenderer.showFormMessage(result.errors.join(', '), 'error');
                    }
                });
            }
            
            // ========== LOAD SAMPLE DATA ==========
            const sampleButton = document.getElementById('loadSampleBtn');
            if (sampleButton) {
                sampleButton.addEventListener('click', function() {
                    if (confirm('Se vor √Ænlocui datele existente. Continua»õi?')) {
                        AppState.loadSample();
                    }
                });
            }
            
            // ========== CLEAR ALL DATA ==========
            const clearButton = document.getElementById('clearAllBtn');
            if (clearButton) {
                clearButton.addEventListener('click', function() {
                    if (confirm('Sigur dori»õi sƒÉ »ôterge»õi TOATE datele?')) {
                        AppState.clearAll();
                    }
                });
            }
            
            // ========== CLEAR COMPLETED ==========
            const clearCompletedButton = document.getElementById('clearCompletedBtn');
            if (clearCompletedButton) {
                clearCompletedButton.addEventListener('click', function() {
                    const result = AppState.deleteWhere(med => med.status === 'Given');
                    if (result.count > 0) {
                        UIRenderer.showFormMessage(`${result.count} element(e) »ôterse`, 'success');
                    }
                });
            }
            
            // ========== CHECK ALERTS ==========
            const checkAlertsButton = document.getElementById('checkAlertsBtn');
            if (checkAlertsButton) {
                checkAlertsButton.addEventListener('click', function() {
                    UIRenderer.renderAlerts();
                    UIRenderer.showFormMessage('Alerte actualizate', 'success');
                });
            }
            
            // ========== EVENT DELEGATION FOR DYNAMIC BUTTONS ==========
            // Medication list (Tab 2) action buttons
            const medicationList = document.getElementById('medicationList');
            if (medicationList) {
                medicationList.addEventListener('click', function(e) {
                    const button = e.target.closest('button[data-action="update-status"]');
                    if (!button) return;
                    
                    const id = parseInt(button.dataset.id);
                    const status = button.dataset.status;
                    
                    if (id && status) {
                        const result = AppState.updateStatus(id, status);
                        if (!result.success) {
                            UIRenderer.showFormMessage(result.error, 'error');
                        }
                    }
                });
            }
            
            // ========== PWA INSTALLATION ==========
            let deferredPrompt;
            const installPrompt = document.getElementById('installPrompt');
            const installButton = document.getElementById('installButton');
            const dismissInstall = document.getElementById('dismissInstall');
            
            // Check if app is already installed
            if (window.matchMedia('(display-mode: standalone)').matches) {
                if (installPrompt) installPrompt.classList.remove('show');
            }
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                if (!localStorage.getItem('installDismissed')) {
                    if (installPrompt) installPrompt.classList.add('show');
                }
            });
            
            if (installButton) {
                installButton.addEventListener('click', async () => {
                    if (!deferredPrompt) return;
                    
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        console.log('App installed');
                        if (installPrompt) installPrompt.classList.remove('show');
                    }
                    
                    deferredPrompt = null;
                });
            }
            
            if (dismissInstall) {
                dismissInstall.addEventListener('click', () => {
                    if (installPrompt) installPrompt.classList.remove('show');
                    localStorage.setItem('installDismissed', 'true');
                });
            }
            
            // ========== ONLINE/OFFLINE DETECTION ==========
            function updateOnlineStatus() {
                const statusIndicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                const offlineBanner = document.getElementById('offlineBanner');
                
                if (navigator.onLine) {
                    if (statusIndicator) {
                        statusIndicator.className = 'status-indicator status-online';
                    }
                    if (statusText) {
                        statusText.textContent = 'Online';
                    }
                    if (offlineBanner) {
                        offlineBanner.classList.remove('show');
                    }
                } else {
                    if (statusIndicator) {
                        statusIndicator.className = 'status-indicator status-offline';
                    }
                    if (statusText) {
                        statusText.textContent = 'Offline';
                    }
                    if (offlineBanner) {
                        offlineBanner.classList.add('show');
                    }
                }
            }
            
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
            
            // ========== AUTO-REFRESH ==========
            // Check alerts every minute
            setInterval(() => {
                UIRenderer.renderAlerts();
            }, 60000);
            
            // Request notification permission
            if ('Notification' in window) {
                Notification.requestPermission();
            }
            
            // ========== SERVICE WORKER REGISTRATION ==========
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registered: ', registration);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
                
                navigator.serviceWorker.addEventListener('message', event => {
                    if (event.data.type === 'SYNC_COMPLETED') {
                        UIRenderer.showFormMessage(event.data.message, 'success');
                    }
                });
            }
        });
    </script>
</body>
</html>